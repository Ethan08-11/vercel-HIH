# 数据库连接与文件存储说明

## ❌ 常见误解

**错误理解**：本地文件存储导致数据库连接失败

**正确理解**：本地文件存储是**数据库连接失败时的降级方案**，不是导致连接失败的原因

---

## 🔄 实际工作流程

### 正常情况（数据库连接成功）

```
应用启动
  ↓
尝试连接 MongoDB
  ↓
✅ 连接成功
  ↓
使用 MongoDB 存储数据
  ↓
数据保存到 MongoDB 数据库
```

### 异常情况（数据库连接失败）

```
应用启动
  ↓
尝试连接 MongoDB
  ↓
❌ 连接失败（原因：端口号错误、网络问题、服务未启动等）
  ↓
自动降级到文件系统存储
  ↓
使用本地文件存储数据（data/ 目录）
  ↓
应用仍然可以正常工作
```

---

## 📋 数据库连接失败的真实原因

### 1. **端口号不匹配**（最常见）

**问题**：
- MongoDB 服务实际使用的端口：`25167`
- 环境变量中配置的端口：`28174`
- **端口号不一致导致连接失败**

**解决方案**：
- 在 Zeabur MongoDB 服务页面查看正确的端口号
- 更新环境变量 `MONGODB_URI` 中的端口号

### 2. **MongoDB 服务未启动**

**问题**：
- MongoDB 服务状态不是 "RUNNING"
- 服务正在启动中（需要 1-3 分钟）

**解决方案**：
- 等待 MongoDB 服务完全启动
- 确认服务状态为 "RUNNING"

### 3. **网络问题**

**问题**：
- Zeabur 内部网络暂时不稳定
- 连接超时

**解决方案**：
- 等待网络恢复
- 检查服务之间的网络连接

### 4. **认证失败**

**问题**：
- 用户名或密码错误
- 连接字符串格式错误

**解决方案**：
- 重新复制完整的连接字符串
- 检查密码是否正确

### 5. **主机名错误**

**问题**：
- 主机名拼写错误（如 `sjcl` 应该是 `sjc1`）

**解决方案**：
- 确认主机名正确：`sjc1.clusters.zeabur.com`（注意是数字 `1`）

---

## 💾 本地文件存储的作用

### 什么是本地文件存储？

当数据库连接失败时，应用会自动使用**文件系统**来存储数据，而不是崩溃或报错。

### 存储位置

- **目录**：`data/` 和 `data/products/`
- **格式**：JSON 文件
- **命名**：`产品ID_产品名称_提交ID.json`

### 为什么需要文件存储？

1. **容错性**：即使数据库连接失败，应用仍然可以正常工作
2. **开发便利**：本地开发时不需要配置数据库
3. **数据不丢失**：数据保存在文件中，不会因为数据库问题而丢失

### 文件存储的局限性

- ✅ **优点**：
  - 应用可以继续运行
  - 数据不会丢失
  - 适合本地开发

- ❌ **缺点**：
  - 数据只保存在服务器本地
  - 无法跨服务器共享数据
  - 不适合生产环境（数据持久化问题）

---

## 🔍 如何判断当前使用的存储方式？

### 方法 1：查看日志

**使用 MongoDB**：
```
✅ MongoDB 连接成功
   数据库: questionnaire
```

**使用文件存储**：
```
⚠️ 数据库连接失败，返回默认值（应用仍可正常使用）
```

### 方法 2：检查 API 响应

**使用 MongoDB**：
```json
{
  "success": true,
  "heartCounts": {...},
  "databaseAvailable": true
}
```

**使用文件存储**：
```json
{
  "success": true,
  "heartCounts": {...},
  "databaseAvailable": false,
  "message": "数据库连接失败，返回默认值（数据仅本地有效）"
}
```

### 方法 3：检查文件系统

如果 `data/` 目录中有新的 JSON 文件，说明正在使用文件存储。

---

## 🎯 在 Zeabur 生产环境中的目标

### 目标状态

```
✅ MongoDB 连接成功
✅ 数据保存到 MongoDB
✅ 所有服务器共享同一数据库
✅ 数据持久化可靠
```

### 当前状态（如果连接失败）

```
❌ MongoDB 连接失败
⚠️ 降级到文件存储
⚠️ 数据只保存在当前服务器
⚠️ 服务器重启后数据可能丢失（取决于 Zeabur 的持久化设置）
```

---

## 🔧 解决数据库连接问题的步骤

### 步骤 1：确认问题

查看 Zeabur Runtime Logs，确认是否看到：
```
❌ MongoDB 连接失败
```

### 步骤 2：检查 MongoDB 服务

1. 进入 Zeabur 控制台
2. 找到 MongoDB 服务
3. 确认状态为 "RUNNING"
4. 查看连接信息（端口号、主机名等）

### 步骤 3：检查环境变量

1. 进入后端服务（如 `questionnaire-backend`）
2. 查看 "Environment Variables"
3. 检查 `MONGODB_URI` 是否正确
4. **特别检查端口号是否与 MongoDB 服务页面显示的端口号一致**

### 步骤 4：更新配置

如果端口号不匹配：
1. 在 MongoDB 服务页面复制完整的连接字符串
2. 更新环境变量 `MONGODB_URI`
3. 等待自动重新部署

### 步骤 5：验证

查看日志，应该看到：
```
✅ MongoDB 连接成功
   数据库: questionnaire
```

---

## 📊 总结

| 项目 | 数据库连接失败 | 本地文件存储 |
|------|---------------|-------------|
| **关系** | 是**原因** | 是**结果**（降级方案） |
| **顺序** | 先发生 | 后发生（连接失败后） |
| **作用** | 导致无法使用数据库 | 让应用继续工作 |
| **解决** | 修复连接问题 | 不需要解决（会自动切换） |

### 关键点

1. **文件存储不会导致连接失败**
2. **连接失败才会触发文件存储**
3. **修复连接问题后，会自动切换回数据库存储**
4. **文件存储是临时的降级方案，不是永久解决方案**

---

## 💡 最佳实践

### 在 Zeabur 生产环境中

1. ✅ **优先使用 MongoDB**：确保环境变量配置正确
2. ✅ **监控连接状态**：定期检查日志
3. ✅ **及时修复问题**：如果连接失败，立即修复
4. ⚠️ **不要依赖文件存储**：文件存储只是临时方案

### 在本地开发环境中

1. ✅ **可以使用文件存储**：不需要配置数据库
2. ✅ **测试数据库连接**：可以配置 MongoDB 进行测试
3. ✅ **理解降级机制**：知道连接失败时会自动降级

---

## 🔗 相关文档

- [配置MongoDB连接.md](./配置MongoDB连接.md) - MongoDB 连接配置详细说明
- [README_BACKEND.md](./README_BACKEND.md) - 后端服务使用说明
