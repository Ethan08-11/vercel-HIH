# 数据同步说明

本文档说明如何将部署在 Zeabur 上的调查数据同步到本地 `data` 文件夹。

## 方法一：使用同步脚本（推荐）

### 1. 获取 MongoDB 连接字符串

在 Zeabur 控制台中：
1. 找到你的 MongoDB 服务
2. 查看环境变量，找到 `MONGODB_URI` 或类似的连接字符串
3. 复制连接字符串

### 2. 配置环境变量

**方法 A：使用 .env 文件（推荐）**

在项目根目录创建 `.env` 文件：

```env
MONGODB_URI=mongodb://username:password@host:port/database
DB_NAME=questionnaire
```

**方法 B：使用命令行环境变量**

Windows:
```cmd
set MONGODB_URI=your_connection_string
set DB_NAME=questionnaire
node sync-data.js
```

Linux/Mac:
```bash
export MONGODB_URI=your_connection_string
export DB_NAME=questionnaire
node sync-data.js
```

### 3. 运行同步脚本

```bash
node sync-data.js
```

### 4. 查看同步结果

脚本会将数据保存到：
- `data/` - 所有提交记录
- `data/products/` - 按产品分类的提交记录
- `data/statistics.json` - 统计信息

## 方法二：使用 Web API 导出

### 1. 访问统计页面

在浏览器中打开：
```
https://questionnaire-app.zeabur.app/统计页面.html
```

或者直接访问：
```
https://questionnaire-app.zeabur.app/api/export
```

### 2. 点击"导出数据"按钮

在统计页面点击"📥 导出数据"按钮，会自动下载 JSON 文件。

### 3. 手动保存到本地

下载的文件包含所有调查数据，你可以：
- 直接查看 JSON 文件内容
- 将数据导入到其他系统
- 手动复制到 `data` 文件夹（如果需要）

## 方法三：使用 API 直接访问

### 获取所有提交记录

```bash
curl https://questionnaire-app.zeabur.app/api/submissions
```

### 获取统计信息

```bash
curl https://questionnaire-app.zeabur.app/api/statistics
```

### 获取指定产品的提交记录

```bash
curl https://questionnaire-app.zeabur.app/api/products/1
```

### 导出所有数据

```bash
curl https://questionnaire-app.zeabur.app/api/export -o questionnaire-export.json
```

## 数据格式说明

### 单个提交记录格式

```json
{
  "submissionId": 1234567890,
  "productId": 1,
  "productName": "玩偶",
  "productImage": "/Picture/1.jpg",
  "answers": {
    "0": true,
    "2": true
  },
  "selectedProducts": [
    {
      "id": 1,
      "name": "玩偶",
      "image": "/Picture/1.jpg"
    }
  ],
  "timestamp": "2024-01-01T00:00:00.000Z",
  "submittedAt": "2024/1/1 00:00:00"
}
```

### 导出文件格式

```json
{
  "exportTime": "2024-01-01T00:00:00.000Z",
  "exportTimeLocal": "2024/1/1 00:00:00",
  "totalSubmissions": 100,
  "submissions": [...],
  "byProduct": {
    "1": {
      "productId": 1,
      "productName": "玩偶",
      "count": 50,
      "submissions": [...]
    }
  }
}
```

## 常见问题

### Q: 同步脚本提示 "MONGODB_URI 未设置"

A: 请确保已正确设置环境变量。检查 `.env` 文件是否存在，或使用命令行设置环境变量。

### Q: 连接 MongoDB 失败

A: 检查：
1. 连接字符串是否正确
2. MongoDB 服务是否正在运行
3. 网络连接是否正常
4. 防火墙是否允许连接

### Q: 同步的数据在哪里？

A: 数据保存在：
- `data/` 目录 - 所有提交记录
- `data/products/` 目录 - 按产品分类
- `data/statistics.json` - 统计信息

### Q: 如何定期同步数据？

A: 可以设置定时任务：

**Windows (任务计划程序):**
```cmd
schtasks /create /tn "Sync Questionnaire Data" /tr "node C:\path\to\sync-data.js" /sc daily /st 09:00
```

**Linux/Mac (crontab):**
```bash
# 每天上午 9 点同步
0 9 * * * cd /path/to/Questionnaire && node sync-data.js >> sync.log 2>&1
```

## 注意事项

1. **数据安全**: MongoDB 连接字符串包含敏感信息，请妥善保管，不要提交到 Git 仓库
2. **文件覆盖**: 同步脚本会跳过已存在的文件，不会覆盖已有数据
3. **数据完整性**: 导出的数据包含所有字段，与数据库中的记录完全一致
4. **网络要求**: 同步需要能够访问部署的 MongoDB 数据库

## 技术支持

如有问题，请检查：
- MongoDB 连接字符串格式
- 网络连接状态
- 数据库服务状态
- 文件系统权限

