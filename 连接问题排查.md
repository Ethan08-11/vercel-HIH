# MongoDB 连接问题排查指南

## ❌ 错误：Server selection timed out

这个错误表示无法在指定时间内连接到 MongoDB 服务器。

## 🔍 排查步骤

### 1. 检查连接字符串格式

**正确的格式：**
```
mongodb://用户名:密码@主机:端口/数据库名?authSource=admin
```

**检查要点：**
- ✅ 以 `mongodb://` 或 `mongodb+srv://` 开头
- ✅ 包含用户名和密码
- ✅ 包含主机地址和端口
- ✅ 包含数据库名称
- ✅ 密码中的特殊字符已正确编码

### 2. 测试网络连接

**Windows:**
```cmd
# 测试主机是否可达（替换为实际主机）
ping sjc1.clusters.zeabur.com

# 测试端口是否开放（替换为实际端口）
telnet sjc1.clusters.zeabur.com 23654
```

**Linux/Mac:**
```bash
# 测试主机
ping sjc1.clusters.zeabur.com

# 测试端口
nc -zv sjc1.clusters.zeabur.com 23654
```

### 3. 检查防火墙设置

**可能的问题：**
- 公司/学校网络防火墙阻止了 MongoDB 端口
- 个人防火墙软件阻止了连接
- 路由器防火墙设置

**解决方法：**
- 尝试使用不同的网络（如手机热点）
- 临时关闭防火墙测试
- 联系网络管理员开放端口

### 4. 检查是否需要 VPN

某些 MongoDB 服务可能需要：
- VPN 连接
- 特定的网络环境
- IP 白名单设置

**检查方法：**
- 查看 Zeabur MongoDB 服务的网络设置
- 确认是否需要配置 IP 白名单

### 5. 验证连接字符串

**常见错误：**

❌ **缺少协议前缀**
```
sjc1.clusters.zeabur.com:23654
```

✅ **正确格式**
```
mongodb://mongo:password@sjc1.clusters.zeabur.com:23654/questionnaire?authSource=admin
```

❌ **密码未编码特殊字符**
```
mongodb://mongo:abc@123@host:port/db
```

✅ **正确编码**
```
mongodb://mongo:abc%40123@host:port/db
```

## 🛠️ 解决方案

### 方案一：使用网页导出（推荐，无需网络配置）

1. 访问统计页面：
   ```
   https://questionnaire-app.zeabur.app/统计页面.html
   ```

2. 点击"📥 导出数据"按钮

3. 下载的 JSON 文件包含所有数据

**优点：**
- 无需配置网络
- 无需本地 MongoDB 连接
- 简单快速

### 方案二：使用 API 导出

**使用 curl:**
```bash
curl https://questionnaire-app.zeabur.app/api/export -o questionnaire-data.json
```

**使用浏览器:**
直接访问：
```
https://questionnaire-app.zeabur.app/api/export
```
浏览器会自动下载 JSON 文件。

### 方案三：修复网络连接

**如果必须使用同步脚本：**

1. **检查网络环境**
   - 尝试使用不同的网络（手机热点、家庭网络等）
   - 确认不是网络限制问题

2. **检查连接字符串**
   ```bash
   # 在 .env 文件中检查
   # 确保格式正确
   MONGODB_URI=mongodb://mongo:密码@主机:端口/数据库?authSource=admin
   ```

3. **增加超时时间**
   编辑 `sync-data.js`，修改超时设置：
   ```javascript
   serverSelectionTimeoutMS: 30000, // 增加到30秒
   ```

4. **使用代理（如果需要）**
   如果网络需要代理，配置环境变量：
   ```bash
   set HTTP_PROXY=http://proxy:port
   set HTTPS_PROXY=http://proxy:port
   ```

### 方案四：使用 MongoDB Compass 测试连接

1. 下载 MongoDB Compass（图形化工具）
2. 使用连接字符串测试连接
3. 如果 Compass 可以连接，说明连接字符串正确
4. 如果 Compass 也无法连接，说明是网络问题

## 📋 诊断命令

### 检查 .env 文件

```bash
# Windows
type .env

# Linux/Mac
cat .env
```

确认 `MONGODB_URI` 格式正确。

### 测试连接字符串

创建一个测试脚本 `test-connection.js`:

```javascript
require('dotenv').config();
const { MongoClient } = require('mongodb');

const uri = process.env.MONGODB_URI;
console.log('测试连接:', uri.replace(/:[^:@]+@/, ':****@'));

const client = new MongoClient(uri, {
    serverSelectionTimeoutMS: 5000
});

client.connect()
    .then(() => {
        console.log('✅ 连接成功！');
        process.exit(0);
    })
    .catch(err => {
        console.error('❌ 连接失败:', err.message);
        process.exit(1);
    });
```

运行：
```bash
node test-connection.js
```

## 🆘 仍然无法解决？

如果以上方法都无法解决，建议：

1. **使用网页导出功能**（最简单可靠）
2. **联系 Zeabur 支持**，确认 MongoDB 服务的网络访问要求
3. **检查 Zeabur 文档**，查看是否有特殊的连接要求

## 📝 临时解决方案

如果急需获取数据，可以：

1. 使用网页导出功能获取数据
2. 手动将 JSON 文件中的数据整理到 `data` 文件夹
3. 或者等待网络问题解决后再同步

