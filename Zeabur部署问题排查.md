# Zeabur 部署问题排查指南

## 问题描述
在Zeabur部署后，数据无法保存并且会自动重置。

## 可能的原因和解决方案

### 1. 环境变量配置问题

**问题**: `MONGODB_URI` 环境变量未正确配置

**解决方案**:
1. 登录 Zeabur 控制台
2. 进入项目设置 → 环境变量
3. 添加环境变量：
   - 变量名: `MONGODB_URI`
   - 变量值: 你的MongoDB连接字符串（格式：`mongodb+srv://username:password@cluster.mongodb.net/database?retryWrites=true&w=majority`）

**验证方法**:
- 检查服务器启动日志，应该看到：
  ```
  ✅ 数据库连接成功
  📊 初始化后的爱心数量: {...}
  ```

### 2. MongoDB 连接超时问题

**问题**: Zeabur 服务器可能位于不同地区，连接 MongoDB 需要更长时间

**已修复**:
- 增加了连接超时时间（从5秒增加到10秒）
- 增加了连接池配置
- 添加了自动重连机制

### 3. 数据库连接字符串格式问题

**检查项**:
- 确保连接字符串包含正确的数据库名称
- 确保连接字符串包含 `retryWrites=true&w=majority` 参数
- 确保 MongoDB Atlas 白名单中包含了 Zeabur 的 IP 地址（或使用 `0.0.0.0/0` 允许所有 IP）

### 4. 数据持久化问题

**已修复**:
- 前端现在会优先使用服务器返回的 `count` 值，即使 `success` 为 `false`
- 添加了更详细的错误日志
- 改进了数据加载逻辑，避免重置现有数据

### 5. API 调用问题

**检查项**:
- 确保 Zeabur 部署的 URL 正确
- 检查浏览器控制台是否有 CORS 错误
- 检查网络请求是否成功（状态码 200）

## 调试步骤

### 步骤 1: 检查环境变量
在 Zeabur 控制台检查 `MONGODB_URI` 是否正确配置。

### 步骤 2: 查看服务器日志
在 Zeabur 控制台查看部署日志，查找以下信息：
- `🚀 开始初始化服务器...`
- `📋 环境检查:`
- `MONGODB_URI: 已配置` 或 `未配置`
- `✅ 数据库连接成功` 或 `❌ 数据库连接失败`

### 步骤 3: 测试 API 端点
使用浏览器或 Postman 测试以下端点：

1. **获取爱心数量**:
   ```
   GET https://your-zeabur-url.zeabur.app/api/heart-counts
   ```
   应该返回：
   ```json
   {
     "success": true,
     "heartCounts": {
       "1": 2000,
       "2": 2000,
       ...
     }
   }
   ```

2. **更新爱心数量**:
   ```
   POST https://your-zeabur-url.zeabur.app/api/heart-count
   Content-Type: application/json
   
   {
     "productId": 1,
     "increment": 1
   }
   ```
   应该返回：
   ```json
   {
     "success": true,
     "productId": 1,
     "count": 2001,
     "message": "数据已保存到服务器"
   }
   ```

### 步骤 4: 检查浏览器控制台
打开浏览器开发者工具（F12），查看：
- Console 标签：检查是否有错误信息
- Network 标签：检查 API 请求是否成功

### 步骤 5: 验证数据持久化
1. 点击图片增加爱心数量
2. 刷新页面
3. 检查爱心数量是否保持（不应该重置为 2000）

## 常见错误和解决方案

### 错误 1: "MONGODB_URI 未设置"
**原因**: 环境变量未配置
**解决**: 在 Zeabur 环境变量中添加 `MONGODB_URI`

### 错误 2: "MongoDB 连接失败"
**原因**: 
- 连接字符串错误
- 网络问题
- MongoDB Atlas 白名单未配置
**解决**: 
- 检查连接字符串格式
- 在 MongoDB Atlas 中添加 `0.0.0.0/0` 到 IP 白名单

### 错误 3: "数据库更新失败：返回值为null"
**原因**: 数据库操作失败
**解决**: 
- 检查 MongoDB 连接
- 查看服务器日志获取详细错误信息
- 确保数据库用户有读写权限

### 错误 4: 数据重置为 2000
**原因**: 
- 前端加载失败
- 服务器返回错误
**解决**: 
- 检查浏览器控制台错误
- 检查网络请求是否成功
- 确保服务器正确返回数据

## 最新修复内容

### 1. 增强的日志记录
- 添加了详细的环境检查日志
- 添加了数据库连接状态日志
- 添加了 API 请求/响应日志

### 2. 改进的错误处理
- 即使 API 返回错误，也使用服务器返回的 `count` 值
- 改进了数据加载逻辑，避免重置现有数据
- 添加了连接重试机制

### 3. 数据库连接优化
- 增加了连接超时时间
- 添加了连接池配置
- 改进了连接验证逻辑

### 4. 前端数据保护
- 优先使用服务器返回的值
- 即使加载失败也不重置现有数据
- 改进了重试机制

## 联系支持

如果问题仍然存在，请提供以下信息：
1. Zeabur 部署日志（特别是启动时的日志）
2. 浏览器控制台错误信息
3. 网络请求的响应内容
4. MongoDB Atlas 连接状态

